<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PulseChat</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #0a0f1f;
  color: #fff;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  background: #020617;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

select {
  background: #1e293b;
  color: white;
  border: none;
  padding: 6px;
  border-radius: 6px;
}

#online {
  font-size: 13px;
  color: #38bdf8;
}

#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.msg {
  max-width: 78%;
  margin-bottom: 10px;
  padding: 10px 14px;
  border-radius: 14px;
  background: #1e293b;
  animation: fade 0.2s ease;
}

.me {
  background: #2563eb;
  margin-left: auto;
}

.sys {
  background: transparent;
  text-align: center;
  font-size: 12px;
  opacity: 0.6;
}

.name {
  font-size: 11px;
  opacity: 0.7;
}

#typing {
  font-size: 12px;
  padding-left: 10px;
  opacity: 0.6;
}

footer {
  display: flex;
  padding: 10px;
  background: #020617;
}

input {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: none;
  outline: none;
}

button {
  margin-left: 8px;
  padding: 12px 16px;
  border-radius: 12px;
  border: none;
  background: #2563eb;
  color: white;
}

@keyframes fade {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<header>
  ‚ö° PulseChat
  <select id="room">
    <option value="global">üåç Global</option>
    <option value="tech">üíª Tech</option>
    <option value="fun">üéÆ Fun</option>
  </select>
  <span id="online">Online: 0</span>
</header>

<div id="messages"></div>
<div id="typing"></div>

<footer>
  <input id="input" placeholder="Type message‚Ä¶" />
  <button onclick="send()">Send</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot, doc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyChLsR1uRkM_mN7igdb0vZHXaSASceDP60",
  authDomain: "globalchitx.firebaseapp.com",
  projectId: "globalchitx",
  storageBucket: "globalchitx.firebasestorage.app",
  messagingSenderId: "125407962400",
  appId: "125407962400"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const uidColor = `hsl(${Math.random()*360},70%,60%)`;
const nick = "User" + Math.floor(Math.random()*9000);
let uid, lastSend = 0;

const msgs = document.getElementById("messages");
const input = document.getElementById("input");
const roomSel = document.getElementById("room");
const onlineEl = document.getElementById("online");
const typingEl = document.getElementById("typing");

signInAnonymously(auth).then(res => {
  uid = res.user.uid;
  setDoc(doc(db,"online",uid),{room:"global"});
  window.addEventListener("beforeunload",()=>deleteDoc(doc(db,"online",uid)));
});

/* SEND */
window.send = async () => {
  const text = input.value.trim();
  if (!text || Date.now()-lastSend < 1200) return;
  lastSend = Date.now();
  input.value = "";

  await addDoc(collection(db,"messages"),{
    text, nick, uid, color: uidColor,
    room: roomSel.value,
    time: serverTimestamp()
  });
};

/* MESSAGES */
function listenRoom() {
  msgs.innerHTML = "";
  onSnapshot(
    query(collection(db,"messages"), orderBy("time")),
    snap => {
      msgs.innerHTML="";
      snap.docs
        .map(d=>d.data())
        .filter(m=>m.room===roomSel.value)
        .slice(-120)
        .forEach(m=>{
          const div=document.createElement("div");
          div.className="msg"+(m.uid===uid?" me":"");
          div.innerHTML=`<div class="name" style="color:${m.color}">${m.nick}</div>${m.text}`;
          msgs.appendChild(div);
        });
      msgs.scrollTop=msgs.scrollHeight;
    }
  );
}
listenRoom();
roomSel.onchange = listenRoom;

/* ONLINE */
onSnapshot(collection(db,"online"), snap=>{
  onlineEl.textContent="Online: "+snap.size;
});

/* TYPING */
input.oninput=()=>{
  setDoc(doc(db,"typing",uid),{nick});
  setTimeout(()=>deleteDoc(doc(db,"typing",uid)),1200);
};

onSnapshot(collection(db,"typing"), snap=>{
  const n=snap.docs.map(d=>d.data().nick).filter(n=>n!==nick);
  typingEl.textContent=n.length?n[0]+" typing‚Ä¶":"";
});
</script>

</body>
</html>